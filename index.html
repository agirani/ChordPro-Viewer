<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChordPro Viewer</title>

  <!-- ‚ñ£ Styles: page layout, output panel, modal, buttons -->
  <style>
    body { font-family: sans-serif; padding: 10px; background: #f9f9f9; }
    #output {
      flex: 1;
      height: 90vh;
      font-family: monospace;
      margin-top: 5px;
      column-gap: 10px;
      overflow-y: auto;
      padding: 1rem;
      box-sizing: border-box;
      line-height: 1.5em;
      scroll-behavior: smooth;
    }

    /* Top control bar */
    #container {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-direction: row;
    }

    /* Scroll control buttons */
    .scroll-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .scroll-buttons button {
      padding: 0.5rem 1rem;
      border: none;
      background: #007aff;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    .scroll-buttons button:hover { background: #005ecb; }

    /* File selection button */
    .file-btn {
      font-size: 15px;
      padding: 8px 16px;
      border-radius: 8px;
      background: #1976d2;
      color: white;
      border: none;
      cursor: pointer;
    }
    .file-btn:hover { background: #0d47a1; }

    /* Modal (server-side file browser & login) */
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }

    /* small-table cell rules for chord formatting */
    .chord-sheet-table td {
      padding: 0;
      margin: 0;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    /* Modal content card */
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      border-radius: 10px;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover { color: black; }

    #fileList {
      list-style: none;
      padding: 0;
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    #fileList li {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    #fileList li:hover { background: #e3f2fd; }

    input[type="range"], input[type="number"] { vertical-align: middle; }

    /* Minor typography fixes */
    h1, h2 { margin: 0; font-size: 15px; }

    .title, .song-title {
      column-span: all;
      font-size: 15px;
      font-weight: bold;
      margin-bottom: 5px;
      text-align: center;
    }
    .subtitle, .song-title {
      column-span: all;
      font-size: 12px;
      font-style: italic;
      margin-bottom: 5px;
      text-align: center;
      color: #555;
    }

    /* Chord sheet container visuals */
    .chord-sheet {
      column-gap: 10px;
      font-family: Courier New;
      color: #333;
      background-color: #f9f9f9;
      padding: 5px;
      border-right: 2px solid #ccc;
      border-radius: 8px;
      margin: auto;
    }

    /* Inline chord/lyrics styling */
    .chord { color: #d32f2f; font-weight: bold; margin-right: 5px; line-height: .5; }
    .comment { color: #0000ff; margin-right: 5px; line-height: .5; }
    .lyrics { color: #000; font-weight: bold; line-height: 1.0; }

    /* Spacing helpers */
    .paragraph { margin-bottom: 20px; }
    .line { margin-bottom: 4px; }
    .line:empty { margin-bottom: 20px; }
    br { line-height: 20em; }
    .blank-line { height: 40px; }

    /* Login form styling */
    #loginForm {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }
    #loginForm input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    #loginForm button {
      padding: 10px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    #loginForm button:hover { background: #0d47a1; }
    
    #userInfo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
      padding: 5px 10px;
      background: #e3f2fd;
      border-radius: 6px;
      font-size: 14px;
    }
    #logoutBtn {
      padding: 4px 8px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    #logoutBtn:hover { background: #d32f2f; }
  </style>

  <script src="bundle.js"></script>
</head>

<body>
  <!-- ‚ñ£ Top control bar: file selector, transpose, font, columns, open-in-new-tab, user info -->
  <div id="container">
    <button class="file-btn" onclick="openFileBrowser()">Select File</button>
    <label>&nbsp;&nbsp;Transpose&nbsp;&nbsp;</label>
    <input type="range" id="transposeSlider" min="-6" max="6" value="0">
    <span id="transposeValue">0</span>

    <label> &nbsp;&nbsp;Font size:&nbsp;  </label>
    <input type="range" min="8" max="36" value="12" id="fontSlider">
    <span id="sizeValue">12</span>

    <label> &nbsp;&nbsp;Columns:&nbsp;  </label>
    <input type="number" id="columnCount" min="1" max="4" value="1">

    <label>&nbsp;&nbsp;&nbsp;</label>
    <button onclick="renderToNewTab()">Open in New Tab</button>

    <!-- User info display -->
    <div id="userInfo" style="display: none;">
      <span>üë§ <strong id="usernameDisplay"></strong></span>
      <button id="logoutBtn" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- ‚ñ£ Scroll controls -->
  <div class="scroll-buttons" id="scrollControls" style="display:none;">
    <label>Scrolling controls</label>
    <button onclick="startAutoScroll(5)">5 sec/line (slow)</button>
    <button onclick="startAutoScroll(2)">2 sec/line (medium)</button>
    <button onclick="startAutoScroll(1)">1 sec/line (fast)</button>
    <button onclick="stopAutoScroll()">Stop</button>
  </div>

  <!-- ‚ñ£ Main rendered output area -->
  <div id="output"></div>

  <!-- ‚ñ£ Modal for server-side file browser -->
  <div id="fileModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3>Select a File</h3>
      <input type="text" id="searchBox" placeholder="Search..." oninput="filterList()" style="width:100%; padding:6px;">
      <ul id="fileList"></ul>
    </div>
  </div>

  <!-- ‚ñ£ Modal for login -->
  <div id="loginModal" class="modal" style="display: block;">
    <div class="modal-content">
      <h3>Welcome to ChordPro Viewer</h3>
      <p>Please enter your name to continue: (this lets me know folks are using the tool)</p>
      <form id="loginForm" onsubmit="handleLogin(event)">
        <input type="text" id="usernameInput" placeholder="Username" required minlength="2" maxlength="30" autocomplete="username">
        <button type="submit">Login</button>
      </form>
    </div>
  </div>

  <!-- ‚ñ£ Script: application logic -->
  <script>
    // -----------------------------
    // ‚ñ£ State variables
    // -----------------------------
    let chordProText = "";
    let file = "";
    let colcount = 1;
    let fontsize = 12;
    let currentPath = "";
    let currentUsername = null;

    // -----------------------------
    // ‚ñ£ Cookie helper functions
    // -----------------------------
    function setCookie(name, value, days) {
      const expires = new Date();
      expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
      document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Strict`;
    }

    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    function deleteCookie(name) {
      document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
    }

    // -----------------------------
    // ‚ñ£ Login/Logout functions
    // -----------------------------
    async function handleLogin(event) {
      event.preventDefault();
      const username = document.getElementById("usernameInput").value.trim();
      
      if (!username) return;

      try {
        // Register/login user with server
        const response = await fetch("https://chordpro-viewer.onrender.com/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username })
        });

        const data = await response.json();
        
        if (data.success) {
          currentUsername = username;
          // Save to both cookie (30 days) and localStorage as backup
          setCookie("chordpro_username", username, 30);
          localStorage.setItem("chordpro_username", username);
          document.getElementById("loginModal").style.display = "none";
          document.getElementById("usernameDisplay").textContent = username;
          document.getElementById("userInfo").style.display = "flex";
        } else {
          alert("Login failed: " + (data.error || "Unknown error"));
        }
      } catch (error) {
        console.error("Login error:", error);
        alert("Unable to connect to server. Please try again.");
      }
    }

    function logout() {
      currentUsername = null;
      // Clear both cookie and localStorage
      deleteCookie("chordpro_username");
      localStorage.removeItem("chordpro_username");
      document.getElementById("userInfo").style.display = "none";
      document.getElementById("loginModal").style.display = "block";
      document.getElementById("usernameInput").value = "";
    }

    // Check for saved username on page load (cookie takes priority)
    window.addEventListener("DOMContentLoaded", async () => {
      // Check cookie first, then localStorage as fallback
      const savedUsername = getCookie("chordpro_username") || localStorage.getItem("chordpro_username");
      
      if (savedUsername) {
        try {
          // Verify username still exists on server
          const response = await fetch("https://chordpro-viewer.onrender.com/verify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: savedUsername })
          });

          const data = await response.json();
          
          if (data.valid) {
            currentUsername = savedUsername;
            // Update both storage methods
            setCookie("chordpro_username", savedUsername, 30);
            localStorage.setItem("chordpro_username", savedUsername);
            document.getElementById("loginModal").style.display = "none";
            document.getElementById("usernameDisplay").textContent = savedUsername;
            document.getElementById("userInfo").style.display = "flex";
          } else {
            // Username no longer valid, clear both
            deleteCookie("chordpro_username");
            localStorage.removeItem("chordpro_username");
          }
        } catch (error) {
          console.error("Verification error:", error);
          // Keep login modal visible if can't verify
        }
      }
    });

    // -----------------------------
    // ‚ñ£ DOM references and controls
    // -----------------------------
    const fontSlider = document.getElementById("fontSlider");
    const slider = document.getElementById("transposeSlider");
    const valueDisplay = document.getElementById("transposeValue");
    const output = document.getElementById("output");

    fontSlider.addEventListener("input", () => {
      fontsize = fontSlider.value;
      document.getElementById("output").style.fontSize = fontsize + "px";
      document.getElementById("sizeValue").textContent = fontsize;
    });

    // -----------------------------
    // ‚ñ£ Column count handler
    // -----------------------------
    document.getElementById("columnCount").addEventListener("change", (e) => {
      colcount = parseInt(e.target.value, 10) || 1;
      const scrollButtons = document.getElementById("scrollControls");

      if (colcount === 1) {
        output.style.removeProperty("column-count");
        output.style.removeProperty("column-gap");
        output.style.whiteSpace = "normal";
        output.style.overflowY = "auto";
        output.style.height = "90vh";
        scrollButtons.style.display = "block";
      } else {
        output.style.columnCount = colcount;
        output.style.columnGap = "2rem";
        output.style.whiteSpace = "normal";
        output.style.overflowY = "auto";
        output.style.overflowX = "hidden";
        scrollButtons.style.display = "none";
        stopAutoScroll();
        output.scrollTop = 0;
      }
    });

    // -----------------------------
    // ‚ñ£ Transpose slider handler
    // -----------------------------
    slider.addEventListener("input", () => {
      valueDisplay.textContent = slider.value;
      render();
    });

    // -----------------------------
    // ‚ñ£ Auto-scroll logic
    // -----------------------------
    let scrollTimer = null;
    let isScrolling = false;

    function startAutoScroll(secondsPerLine) {
      stopAutoScroll();
      const lineHeight = fontsize;
      const interval = secondsPerLine * 1000;
      if (isScrolling) return;
      isScrolling = true;
      scrollTimer = setInterval(() => {
        if (output.scrollTop + output.clientHeight >= output.scrollHeight) {
          stopAutoScroll();
          return;
        }
        output.scrollTop += lineHeight;
      }, interval);
    }

    function stopAutoScroll() {
      if (scrollTimer) {
        clearInterval(scrollTimer);
        scrollTimer = null;
      }
      isScrolling = false;
    }

    // -----------------------------
    // ‚ñ£ Render function
    // -----------------------------
    async function render() {
      try {
        const delta = slider.value;
        const parser = new ChordSheetJS.ChordProParser();
        let song = parser.parse(chordProText);
        if (delta != 0) song = song.transpose(delta);
        const formatter = new ChordSheetJS.HtmlTableFormatter();
        document.getElementById("output").innerHTML = formatter.format(song);
      } catch (err) {
        console.error("ChordPro render error:", err);
        const outputElem = document.getElementById("output");
        outputElem.innerHTML = `
          <div style="color:red; font-weight:bold;">
            ‚ö†Ô∏è Error parsing ChordPro file.<br>
            ${err.message || "Unknown error"}
          </div>
          <pre style="
            background:#f4f4f4;
            border:1px solid #ccc;
            padding:10px;
            font-family:monospace;
            white-space:pre-wrap;
            color:#333;
            max-height:400px;
            overflow:auto;
          ">${chordProText.replace(/[<>]/g, (c) => c === '<' ? '&lt;' : '&gt;')}</pre>
        `;
      }

      const scrollButtons = document.getElementById("scrollControls");
      if (colcount === 1) {
        scrollButtons.style.display = "block";
      } else {
        scrollButtons.style.display = "none";
        stopAutoScroll();
      }
    }

    // -----------------------------
    // ‚ñ£ Server file browser
    // -----------------------------
    async function loadDirectory(path = "") {
      const res = await fetch(`https://chordpro-viewer.onrender.com/files`);
      const data = await res.json();
      const fileList = document.getElementById("fileList");
      fileList.innerHTML = "";
      currentPath = path;

      if (path) {
        const upPath = path.split("/").slice(0, -1).join("/");
        const up = document.createElement("li");
        up.textContent = "‚¨ÜÔ∏è Up";
        up.onclick = () => loadDirectory(upPath);
        fileList.appendChild(up);
      }

      data.sort((a, b) => (b.is_dir - a.is_dir) || a.name.localeCompare(b.name));

      data.forEach(item => {
        const li = document.createElement("li");
        li.textContent = (item.is_dir ? "üìÅ " : "üéµ ") + item.name;
        li.onclick = () => {
          if (item.is_dir) loadDirectory(item.path);
          else loadFile(item.path);
        };
        fileList.appendChild(li);
      });
    }

    async function loadFile(path) {
      const res = await fetch(`https://chordpro-viewer.onrender.com/file?path=${encodeURIComponent(path)}`);
      chordProText = await res.text();
      file = { name: path };
      render();
      closeModal();
    }

    // -----------------------------
    // ‚ñ£ Utility functions
    // -----------------------------
    function filterList() {
      const query = document.getElementById("searchBox").value.toLowerCase();
      document.querySelectorAll("#fileList li").forEach(li => {
        li.style.display = li.textContent.toLowerCase().includes(query) ? "" : "none";
      });
    }

    function openFileBrowser() {
      if (document.getElementById("searchBox"))
        document.getElementById("searchBox").value = "";
      document.getElementById("fileModal").style.display = "block";
      loadDirectory();
    }

    function closeModal() {
      document.getElementById("fileModal").style.display = "none";
    }

    // -----------------------------
    // ‚ñ£ New-tab rendering
    // -----------------------------
    function renderToNewTab() {
      if (!file || !chordProText) return;
      const delta = slider.value;
      const parser = new ChordSheetJS.ChordProParser();
      let song = parser.parse(chordProText);
      if (delta != 0) song = song.transpose(delta);
      const formatter = new ChordSheetJS.HtmlTableFormatter();
      const rendered = formatter.format(song);

      const newWin = window.open("", "_blank");
      const doc = newWin.document;
      doc.title = file.name;

      const style = doc.createElement("style");
      style.textContent = `
        body { font-family: monospace; padding: 10px; background: #f9f9f9; font-size: ${fontsize}px; }
        .scroll-buttons { display: flex; gap: 0.5rem; margin-bottom: 10px; }
        .scroll-buttons button { padding: 0.5rem 1rem; border: none; background: #007aff; color: white; border-radius: 6px; cursor: pointer; }
        .scroll-buttons button:hover { background: #005ecb; }
        #output { 
          ${colcount > 1 ? `column-count: ${colcount}; column-gap: 2rem;` : ''}
          overflow-y: auto; 
          height: 90vh; 
          padding: 1rem; 
          scroll-behavior: smooth; 
        }
      `;
      doc.head.appendChild(style);

      const scrollDiv = doc.createElement("div");
      scrollDiv.className = "scroll-buttons";
      const btnSlow = doc.createElement("button"); btnSlow.textContent = "5 sec/line (slow)";
      const btnMed  = doc.createElement("button"); btnMed.textContent = "2 sec/line (medium)";
      const btnFast = doc.createElement("button"); btnFast.textContent = "1 sec/line (fast)";
      const btnStop = doc.createElement("button"); btnStop.textContent = "Stop";
      scrollDiv.appendChild(btnSlow);
      scrollDiv.appendChild(btnMed);
      scrollDiv.appendChild(btnFast);
      scrollDiv.appendChild(btnStop);

      if (colcount !== 1) scrollDiv.style.display = "none";

      doc.body.appendChild(scrollDiv);

      const outputDiv = doc.createElement("div");
      outputDiv.id = "output";
      outputDiv.innerHTML = rendered;
      doc.body.appendChild(outputDiv);

      let newScrollTimer = null;
      let newIsScrolling = false;

      function newStartAutoScroll(secondsPerLine) {
        newStopAutoScroll();
        const lineHeight = fontsize;
        const interval = secondsPerLine * 1000;
        if (newIsScrolling) return;
        newIsScrolling = true;
        newScrollTimer = setInterval(() => {
          if (outputDiv.scrollTop + outputDiv.clientHeight >= outputDiv.scrollHeight) {
            newStopAutoScroll();
            return;
          }
          outputDiv.scrollTop += lineHeight;
        }, interval);
      }

      function newStopAutoScroll() {
        if (newScrollTimer) {
          clearInterval(newScrollTimer);
          newScrollTimer = null;
        }
        newIsScrolling = false;
      }

      btnSlow.addEventListener("click", () => newStartAutoScroll(5));
      btnMed.addEventListener("click",  () => newStartAutoScroll(2));
      btnFast.addEventListener("click", () => newStartAutoScroll(1));
      btnStop.addEventListener("click",  newStopAutoScroll);

      try {
        newWin.newStartAutoScroll = newStartAutoScroll;
        newWin.newStopAutoScroll = newStopAutoScroll;
      } catch (e) {}

      newWin.focus();
    }

    window.addEventListener("click", (e) => {
      const modal = document.getElementById("fileModal");
      if (e.target == modal) closeModal();
    });
  </script>
</body>
</html>